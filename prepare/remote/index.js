require('./sourcemap-register.js');module.exports=function(e,n){"use strict";var t={};function __webpack_require__(n){if(t[n]){return t[n].exports}var i=t[n]={i:n,l:false,exports:{}};var o=true;try{e[n].call(i.exports,i,i.exports,__webpack_require__);o=false}finally{if(o)delete t[n]}i.l=true;return i.exports}__webpack_require__.ab=__dirname+"/";function startup(){return __webpack_require__(96)}n(__webpack_require__);return startup()}({2:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.ensureLinkIs=n.ensureFilesAre=n.ensureFileIs=n.ensureFileContains=n.exists=n.mkdir=n.copyFile=n.chmod=n.chown=n.unlink=void 0;const o=t(747);const r=t(9);function unlink(...e){return i(this,void 0,void 0,function*(){const[n]=e;r.debug("unlink:",n);yield o.promises.unlink(...e)})}n.unlink=unlink;function chown(...e){return i(this,void 0,void 0,function*(){const[n,t]=e;r.debug("chown:",n,"to",t);yield o.promises.chown(...e)})}n.chown=chown;function chmod(...e){return i(this,void 0,void 0,function*(){const[n,t]=e;r.debug("chmod:",n,"to",t);yield o.promises.chmod(...e)})}n.chmod=chmod;function copyFile(...e){return i(this,void 0,void 0,function*(){const[n,t]=e;r.debug("copyFile:",n,"to",t);yield o.promises.copyFile(...e)})}n.copyFile=copyFile;function mkdir(e,n){return i(this,void 0,void 0,function*(){if(typeof n!=="object"){n={mode:n}}n=Object.assign({recursive:true},n);r.debug("mkdir:",e);yield o.promises.mkdir(e,n)})}n.mkdir=mkdir;function exists(e){return i(this,void 0,void 0,function*(){return o.promises.access(e).then(()=>true,()=>false)})}n.exists=exists;function ensureFileContains(e,n){return i(this,void 0,void 0,function*(){const t=(yield o.promises.readFile(e).catch(()=>"")).toString();if(t.includes(n))return false;r.debug("Appending to file:",e,"bytes:",n.length);yield o.promises.writeFile(e,t+n);return true})}n.ensureFileContains=ensureFileContains;function ensureFileIs(e,n,t){return i(this,void 0,void 0,function*(){const i=(yield o.promises.readFile(e).catch(()=>"")).toString();if(i===n)return false;r.debug("Writing to file:",e,"bytes:",n.length);yield o.promises.writeFile(e,n,{mode:t});return true})}n.ensureFileIs=ensureFileIs;function ensureFilesAre(e){return i(this,void 0,void 0,function*(){yield Promise.all(e.map(({filename:e,contents:n})=>ensureFileIs(e,n)))})}n.ensureFilesAre=ensureFilesAre;function ensureLinkIs(e,n){return i(this,void 0,void 0,function*(){const t=yield o.promises.readlink(n).catch(e=>{if(e.code==="ENOENT")return undefined;throw e});if(e===t)return false;if(t!==undefined)yield unlink(n);r.debug("Updating symlink",n,"to point to",e);yield o.promises.symlink(e,n);return true})}n.ensureLinkIs=ensureLinkIs},9:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.verbosityLevel=n.debug=n.input=void 0;const o=t(470);const r=t(899);const s=t(669);function input(e){return i(this,void 0,void 0,function*(){if(!r.isGitHubAction){throw new Error("Not made to work in other environments yet!")}return o.getInput(e)})}n.input=input;function debug(...e){if(r.isGitHubAction){o.debug(s.formatWithOptions({colors:true},...e));return}if(process.env.DEBUG===undefined)return;console.log(...e)}n.debug=debug;function verbosityLevel(){return i(this,void 0,void 0,function*(){const e=yield input("verbosity");const n=parseInt(e);if(!isFinite(n))throw new Error(`Invalid verbosity: ${e}.`);if(n<0)throw new RangeError(`Invalid verbosity: ${n}. 0 is minimum.`);if(n>3)throw new RangeError(`Invalid verbosity: ${n}. 3 is maximum.`);return n})}n.verbosityLevel=verbosityLevel},16:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupNetdata=void 0;const o=t(311);function setupNetdata(){return i(this,void 0,void 0,function*(){const e="https://my-netdata.io/kickstart-static64.sh";yield o.exec(`bash <(curl -Ss "${e}") --dont-wait`)})}n.setupNetdata=setupNetdata},37:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupTimezone=void 0;const o=t(2);const r=t(469);function setupTimezone(){return i(this,void 0,void 0,function*(){const{runtimeServerTimezone:e}=yield r.readAvenConfig();if(!e)return;console.log("Setting timezone to:",e);const n="/etc/localtime";const t=`/usr/share/zoneinfo/${e}`;yield o.ensureLinkIs(t,n)})}n.setupTimezone=setupTimezone},42:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupNginx=void 0;const o=t(2);const r=t(311);const s=t(285);const c=t(469);const u=t(9);s.addAptDependencies("nginx","certbot","ssl-cert");const a="/var/lib/letsencrypt/webroot";const l="/etc/letsencrypt/live";const d=`user www-data;\nworker_processes auto;\npid /run/nginx.pid;\n\ninclude modules-enabled/*.conf;\n\nevents {\n    worker_connections 768;\n    # multi_accept on;\n}\n\nhttp {\n    include conf.d/*.conf;\n}\n`;function setupNginxSnips(){return i(this,void 0,void 0,function*(){const e="/etc/nginx/snips";yield o.mkdir(e);const n={};n["force-main-https"]=`location / {\n    return 301 https://$server_name$request_uri;\n    #rewrite ^ https://$server_name$request_uri? permanent;\n}\n`;n.letsencrypt=`location ^~ /.well-known/acme-challenge/ {\n    default_type "text/plain";\n    root ${a};\n}\n\nlocation = /.well-known/acme-challenge/ {\n    return 404;\n}\n`;n["proxy-forwarded-headers"]=`proxy_set_header Host $host;\nproxy_set_header Forwarded $proxy_add_forwarded;\n`;n["proxy-headers"]=`proxy_set_header Host $host;\n#proxy_set_header Port $server_port;\n#proxy_set_header X-Forwarded-Port $server_port;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-Proto $scheme;\n#proxy_set_header X-Forwarded-Ssl $https;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n#proxy_set_header X-Frame-Options SAMEORIGIN;\n`;n["trust-cloudflare-ip"]=`set_real_ip_from 103.21.244.0/22;\nset_real_ip_from 103.22.200.0/22;\nset_real_ip_from 103.31.4.0/22;\nset_real_ip_from 104.16.0.0/12;\nset_real_ip_from 108.162.192.0/18;\nset_real_ip_from 131.0.72.0/22;\nset_real_ip_from 141.101.64.0/18;\nset_real_ip_from 162.158.0.0/15;\nset_real_ip_from 172.64.0.0/13;\nset_real_ip_from 173.245.48.0/20;\nset_real_ip_from 188.114.96.0/20;\nset_real_ip_from 190.93.240.0/20;\nset_real_ip_from 197.234.240.0/22;\nset_real_ip_from 198.41.128.0/17;\nset_real_ip_from 2400:cb00::/32;\nset_real_ip_from 2606:4700::/32;\nset_real_ip_from 2803:f800::/32;\nset_real_ip_from 2405:b500::/32;\nset_real_ip_from 2405:8100::/32;\nset_real_ip_from 2c0f:f248::/32;\nset_real_ip_from 2a06:98c0::/29;\n\n# use any of the following two\nreal_ip_header CF-Connecting-IP;\n#real_ip_header X-Forwarded-For;\n`;n["websockets-proxy-headers"]=`proxy_http_version 1.1;\nproxy_set_header Upgrade $http_upgrade;\nproxy_set_header Connection $connection_upgrade;\n`;yield Promise.all([o.ensureLinkIs("../snippets/fastcgi-php.conf",`${e}/fastcgi-php.conf`),o.ensureFilesAre(Object.entries(n).map(([n,t])=>({filename:`${e}/${n}.conf`,contents:t})))])})}function setupNginxConfigs(){return i(this,void 0,void 0,function*(){const e="/etc/nginx/conf.d";const{domains:n}=yield c.readAvenConfig();if(!n)throw new Error("Domains unset!");const t={public:"/etc/ssl/certs/ssl-cert-snakeoil.pem",private:"/etc/ssl/private/ssl-cert-snakeoil.key"};yield o.exists(`${l}/${n[0]}/fullchain.pem`).then(e=>{if(e){t.public=`${l}/${n[0]}/fullchain.pem`;t.private=`${l}/${n[0]}/privkey.pem`}});const i={};i.basic=`sendfile on;\ntcp_nopush on;\ntcp_nodelay on;\nkeepalive_timeout 65;\ntypes_hash_max_size 2048;\n# server_tokens off;\n\n# server_names_hash_bucket_size 64;\n# server_name_in_redirect off;\n\ninclude /etc/nginx/mime.types;\ndefault_type application/octet-stream;\n`;i.gzip=`gzip on;\ngzip_disable "msie6";\n\n# gzip_vary on;\n# gzip_proxied any;\n# gzip_comp_level 6;\n# gzip_buffers 16 8k;\n# gzip_http_version 1.1;\n# gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;\n`;i["http-upgrade"]=`map $http_upgrade $connection_upgrade {\n    default upgrade;\n    ''      close;\n}\n`;i.logging=`access_log /var/log/nginx/access.log;\nerror_log /var/log/nginx/error.log;\n`;const r='"~^(,[ \\\\t]*)*([!#$%&\'*+.^_`|~0-9A-Za-z-]+=([!#$%&\'*+.^_`|~0-9A-Za-z-]+|\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\"))?(;([!#$%&\'*+.^_`|~0-9A-Za-z-]+=([!#$%&\'*+.^_`|~0-9A-Za-z-]+|\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\"))?)*([ \\\\t]*,([ \\\\t]*([!#$%&\'*+.^_`|~0-9A-Za-z-]+=([!#$%&\'*+.^_`|~0-9A-Za-z-]+|\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\"))?(;([!#$%&\'*+.^_`|~0-9A-Za-z-]+=([!#$%&\'*+.^_`|~0-9A-Za-z-]+|\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\"))?)*)?)*$"\n';i["proxy-add-forwarded"]=`map $remote_addr $proxy_forwarded_elem {\n    # IPv4 addresses can be sent as-is\n    ~^[0-9.]+$          "for=$remote_addr";\n\n    # IPv6 addresses need to be bracketed and quoted\n    ~^[0-9A-Fa-f:.]+$   "for=\\"[$remote_addr]\\"";\n\n    # Unix domain socket names cannot be represented in RFC 7239 syntax\n    default             "for=unknown";\n}\n\nmap $http_forwarded $proxy_add_forwarded {\n    # If the incoming Forwarded header is syntactically valid, append to it\n    ${r} "$http_forwarded, $proxy_forwarded_elem";\n\n    # Otherwise, replace it\n    default "$proxy_forwarded_elem";\n}\n`;i.servers=`include servers/*.conf;\n`;i.ssl=`##\n# SSL Settings\n##\n\n# Default keys. Overridden in server configs.\nssl_certificate     ${t.public};\nssl_certificate_key ${t.private};\n\n\nssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE\nssl_prefer_server_ciphers on;\n`;yield o.mkdir(e).then(()=>o.ensureFilesAre(Object.entries(i).map(([n,t])=>({filename:`${e}/${n}.conf`,contents:t}))))})}function setupNginxBasicServers(){return i(this,void 0,void 0,function*(){const e="/etc/nginx/servers";yield o.mkdir(e);const n=`server {\n      listen 80;\n      listen [::]:80;\n      listen 443 ssl;\n      listen [::]:443 ssl;\n  \n      include snips/letsencrypt.conf;\n  \n      location / {\n          default_type text/plain;\n          return 200 'Nothing to see here...';\n      }\n  }\n  `;yield o.ensureFileIs(`${e}/00_default.conf`,n)})}function setupNginxServersFull(){return i(this,void 0,void 0,function*(){const{webRootPath:e,domains:n,service:{name:t}}=yield c.readAvenConfig();if(!n)throw new Error("Domains unset!");if(e)yield o.mkdir(e);const i=n[0].replace(".","_");const r="sock";const s=`/run/${t}`;const u=`unix:${s}/${r}`;const a=`server {\n    server_name ${n.join(" ")};\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    include snips/letsencrypt.conf;\n    include snips/force-main-https.conf;\n}\n\nserver {\n    server_name ${n.join(" ")};\n    listen 443 ssl default_server;\n    listen [::]:443 ssl default_server;\n\n    ssl_certificate     ${l}/${n[0]}/fullchain.pem;\n    ssl_certificate_key ${l}/${n[0]}/privkey.pem;\n\n    include snips/trust-cloudflare-ip.conf;\n\n    location / ${!e?"":`{\n      root ${e};\n      # If files exist in root, serve them. Otherwise fallback to proxy.\n      try_files $uri $uri/index.html @proxyHandler;\n    }\n    \n    location @proxyHandler `}{\n        include snips/websockets-proxy-headers.conf;\n        include snips/proxy-headers.conf;\n        proxy_pass http://${i};\n    }\n}\n\nupstream ${i} {\n    server ${u} fail_timeout=0;\n}\n`;yield o.ensureFileIs(`/etc/nginx/servers/${n[0]}.conf`,a)})}const p="/etc/nginx/nginx.conf";function setupNginxBasic(){return i(this,void 0,void 0,function*(){yield Promise.all([o.ensureFileIs(p,d),setupNginxSnips(),setupNginxConfigs(),setupNginxBasicServers()])})}const f=`authenticator = webroot\nwebroot-path = ${a}\n\n# Because we are using logrotate for greater flexibility, disable the\n# internal certbot logrotation.\nmax-log-backups = 0\n`;const h=`#!/bin/bash\nsystemctl reload nginx\n`;function setupCertbot(){return i(this,void 0,void 0,function*(){const{domains:e}=yield c.readAvenConfig();if(!e)throw new Error("Domains unset!");yield Promise.all([o.ensureFileIs("/etc/letsencrypt/cli.ini",f),o.mkdir(a)]);const n="/var/lib/znc/znc.pem";const t=`#!/bin/bash\nYOURDOMAIN="${e[0]}"\n\n[[ $RENEWED_LINEAGE != "${l}/$YOURDOMAIN" ]] && exit 0\n\n# Combine certs into single file for some applications that don't support separation\ncat ${l}/$YOURDOMAIN/{privkey,fullchain}.pem > ${n}\n`;function doCertbot(){return i(this,void 0,void 0,function*(){if(!e)throw new Error("Domains unset!");yield r.spawn("certbot","certonly","--expand","--noninteractive","--agree-tos","-m",`admin@${e[0]}`,...e.reduce((e,n)=>e.concat("--domain",n),[]))})}yield doCertbot().catch(()=>i(this,void 0,void 0,function*(){yield new Promise(e=>setTimeout(e,15e3));return doCertbot()}));const s="/etc/letsencrypt/renewal-hooks/deploy/reload-nginx";yield o.ensureFileIs(s,h);yield o.chmod(s,493)})}function checkNginxConfig(){return i(this,void 0,void 0,function*(){yield r.spawn("nginx","-tc",p)})}function setupNginx(){return i(this,void 0,void 0,function*(){const{domains:e}=yield c.readAvenConfig();if(!e)return;yield setupNginxBasic();yield checkNginxConfig().catch(()=>i(this,void 0,void 0,function*(){u.debug("Something went wrong. Clearing possibly broken configs and trying again.");yield Promise.all(e.map(e=>o.unlink(`/etc/nginx/servers/${e}.conf`).catch(()=>{})));yield checkNginxConfig()}));yield r.exec(`systemctl reload nginx.service`);yield setupCertbot();yield setupNginxServersFull();yield checkNginxConfig();yield r.exec(`systemctl reload nginx.service`)})}n.setupNginx=setupNginx},56:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupJournalbeat=void 0;const o=t(2);const r=t(311);const s=t(469);function setupJournalbeat(){return i(this,void 0,void 0,function*(){const{journalbeat:e}=yield s.readAvenConfig();if(!e)return;yield r.exec("wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -");yield o.ensureFileIs("/etc/apt/sources.list.d/elastic-7.x.list","deb https://artifacts.elastic.co/packages/7.x/apt stable main\n");yield r.exec("apt-get update");yield r.exec("apt-get install -y journalbeat");yield r.exec("systemctl enable journalbeat");const n=`\n[Service]\nEnvironment="BEAT_LOG_OPTS= "\n`;const t=o.mkdir("/lib/systemd/system/journalbeat.service.d").then(()=>o.ensureFileIs("/lib/systemd/system/journalbeat.service.d/disable-logging.conf",n)).then(()=>r.exec("systemctl daemon-reload"));let i=`journalbeat.inputs:\n- paths: []\n  #backoff: 1s\n  #max_backoff: 20s\n  seek: cursor\n  #cursor_seek_fallback: head\n  #include_matches: []\n  #fields:\n\n#journalbeat:\n  #registry_file: registry\n\nsetup.template.settings:\n  index.number_of_shards: 1\n  #index.codec: best_compression\n  #_source.enabled: false\n\n#name:\n#tags: ["service-X", "web-tier"]\n#fields:\n\n#setup.dashboards.enabled: false\n#setup.dashboards.url:\n\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~  \n  - decode_json_fields:\n      fields: ["message"]\n      process_array: true\n      max_depth: 8\n      target: ""\n\n#logging.level: debug\n#logging.selectors: ["*"]\n\n#monitoring.enabled: false\n#monitoring.cluster_uuid:\n#monitoring.elasticsearch:\n\n#migration.6_to_7.enabled: true\n`;if(e.kibanaHost){i+=`\nsetup.kibana:\n  host: "${e.kibanaHost}"\n`}let c=0;if(e.elastic.hosts.length){c++;i+=`\noutput.elasticsearch:\n  hosts: ${JSON.stringify(e.elastic.hosts)}\n  #protocol: "https"\n  username: ${JSON.stringify(e.elastic.username)}\n  password: ${JSON.stringify(e.elastic.password)}\n`}if(e.logstashHosts.length){if(c){console.log("Skipping logstash config in favor of elasticsearch")}else{c++;i+=`\noutput.logstash:\n  hosts: ${JSON.stringify(e.logstashHosts)}\n  #ssl.certificate_authorities: ["/etc/pki/root/ca.pem"]\n  #ssl.certificate: "/etc/pki/client/cert.pem"\n  #ssl.key: "/etc/pki/client/cert.key"\n`}}if(!c)console.log("Warning: No journalbeat outputs configured");const u=yield o.ensureFileIs("/etc/journalbeat/journalbeat.yml",i);yield t;yield r.exec(`systemctl ${u?"restart":"start"} journalbeat`)})}n.setupJournalbeat=setupJournalbeat},87:function(e){e.exports=require("os")},96:function(e,n,t){"use strict";e=t.nmd(e);var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.prepare=void 0;const o=t(42);const r=t(438);const s=t(263);const c=t(425);const u=t(305);function prepare(){return i(this,void 0,void 0,function*(){yield u.printOSInfo();yield c.basicServerSetup();yield Promise.all([s.setupMonitoringTools(),o.setupNginx(),r.setupMainServiceFiles()]);console.log("Server configured!")})}n.prepare=prepare;if(!e.parent){prepare().catch(e=>{console.log("Error running!");console.log(e);process.exitCode=1})}},129:function(e){e.exports=require("child_process")},263:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupMonitoringTools=void 0;const o=t(56);const r=t(16);const s=t(947);const c=t(274);const u=t(291);function setupMonitoringTools(){return i(this,void 0,void 0,function*(){yield Promise.all([o.setupJournalbeat(),r.setupNetdata(),s.setupCockpit(),c.setupFailureNotificationService(),u.setupPersistentJournal()])})}n.setupMonitoringTools=setupMonitoringTools},274:function(e,n){"use strict";var t=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupFailureNotificationService=void 0;function setupFailureNotificationService(){return t(this,void 0,void 0,function*(){})}n.setupFailureNotificationService=setupFailureNotificationService},285:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupAptDependencies=n.addAptDependencies=void 0;const o=t(2);const r=t(311);const s=t(469);const c=[];function addAptDependencies(...e){c.push(...e)}n.addAptDependencies=addAptDependencies;function setupAptDependencies(){var e,n;return i(this,void 0,void 0,function*(){yield r.exec("curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -");yield o.ensureFileIs("/etc/apt/sources.list.d/yarn.list","deb https://dl.yarnpkg.com/debian/ stable main");addAptDependencies("yarn");yield r.spawn("apt-get","update");yield r.spawn("apt-get","upgrade","-y");const t=yield s.readAvenConfig();addAptDependencies(...(e=t.aptDependencies)!==null&&e!==void 0?e:[]);addAptDependencies(...(n=t.runtimeAptDependencies)!==null&&n!==void 0?n:[]);const i=true;const u=i?"force-confnew":"force-confdef\nforce-confold";yield o.ensureFileIs("/etc/dpkg/dpkg.cfg.d/force-conf.cfg",`${u}\n`);yield r.spawn("apt-get",{stdio:"inherit",env:Object.assign(Object.assign({},process.env),{DEBIAN_FRONTEND:"noninteractive"})},"install","-yq",...new Set(c));yield r.spawn("apt-get","autoremove","-y")})}n.setupAptDependencies=setupAptDependencies},291:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupPersistentJournal=void 0;const o=t(2);function setupPersistentJournal(){return i(this,void 0,void 0,function*(){yield o.mkdir("/var/log/journal")})}n.setupPersistentJournal=setupPersistentJournal},305:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.printOSInfo=void 0;const o=t(747);const{readFile:r}=o.promises;function printOSInfo(){return i(this,void 0,void 0,function*(){const e=(yield r("/etc/lsb-release")).toString();const n=e.split("\n")[3].split("=")[1].split('"')[1];console.log("OS Version",n)})}n.printOSInfo=printOSInfo},311:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.exec=n.spawn=void 0;const i=t(129);const o=t(669);const r=t(9);const s="/bin/bash";function spawn(e,n,...t){const o={stdio:"inherit"};let c;if(typeof n==="string"){t.unshift(n);c=o}else{if(n===true){c=Object.assign(Object.assign({},o),{shell:s})}else{c=Object.assign(Object.assign({},o),n)}}r.debug("Spawning",e,t);const u=i.spawn(e,t,c);const a=new Promise((e,n)=>{u.on("exit",t=>{if(t){const e=new Error(`Exit code: ${t}`);e.exitCode=t;n(e)}else{e()}})});a.child=u;return a}n.spawn=spawn;const c=o.promisify(i.exec);function exec(e,n=true){r.debug("Exec:",e);if(n===null){return c(e)}if(n===true)n=s;return c(e,{shell:n})}n.exec=exec},411:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupSecurity=void 0;const o=t(2);const r=t(311);function setupSecurity(){return i(this,void 0,void 0,function*(){const e=yield o.ensureFileContains("/etc/ssh/sshd_config","\nPasswordAuthentication no\n");if(e){yield r.exec("systemctl reload sshd")}})}n.setupSecurity=setupSecurity},425:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.basicServerSetup=void 0;const o=t(37);const r=t(285);const s=t(411);const c=t(469);const u=t(708);function basicServerSetup(){return i(this,void 0,void 0,function*(){yield Promise.all([s.setupSecurity(),c.readAvenConfig().then(e=>e.authorizedKeys).then(e=>i(this,void 0,void 0,function*(){if(e.length)return u.setAuthorizedKeys("root",e)})),o.setupTimezone()]);yield r.setupAptDependencies()})}n.basicServerSetup=basicServerSetup},431:function(e,n,t){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(e!=null)for(var t in e)if(Object.hasOwnProperty.call(e,t))n[t]=e[t];n["default"]=e;return n};Object.defineProperty(n,"__esModule",{value:true});const o=i(t(87));function issueCommand(e,n,t){const i=new Command(e,n,t);process.stdout.write(i.toString()+o.EOL)}n.issueCommand=issueCommand;function issue(e,n=""){issueCommand(e,{},n)}n.issue=issue;const r="::";class Command{constructor(e,n,t){if(!e){e="missing.command"}this.command=e;this.properties=n;this.message=t}toString(){let e=r+this.command;if(this.properties&&Object.keys(this.properties).length>0){e+=" ";let n=true;for(const t in this.properties){if(this.properties.hasOwnProperty(t)){const i=this.properties[t];if(i){if(n){n=false}else{e+=","}e+=`${t}=${escapeProperty(i)}`}}}}e+=`${r}${escapeData(this.message)}`;return e}}function toCommandValue(e){if(e===null||e===undefined){return""}else if(typeof e==="string"||e instanceof String){return e}return JSON.stringify(e)}n.toCommandValue=toCommandValue;function escapeData(e){return toCommandValue(e).replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A")}function escapeProperty(e){return toCommandValue(e).replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A").replace(/:/g,"%3A").replace(/,/g,"%2C")}},438:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupMainServiceFiles=void 0;const o=t(311);const r=t(2);const s=t(469);function setupMainServiceFiles(){var e;return i(this,void 0,void 0,function*(){const{service:n}=yield s.readAvenConfig();const t=n.name;const c=(e=n.description)!==null&&e!==void 0?e:"Runtime server";const u=n.startServerCommand;const a=n.extraConfigs;const l=`/etc/systemd/system/${t}.service`;const d=`/var/lib/${t}`;const p="www-data";const f=o.exec(`id -u ${p}`);const h=o.exec(`id -g ${p}`);const v=r.mkdir(`${l}.d`);const y=r.mkdir(`/opt/aven`);const _=r.mkdir(d).then(()=>i(this,void 0,void 0,function*(){return yield Promise.all([r.chmod(d,448),r.chown(d,Number((yield f).stdout),Number((yield h).stdout))])}));const m=`[Unit]\nDescription=${c}\nAfter=network.target\n\n[Service]\nType=simple\nRestart=always\nEnvironment=LISTEN_PATH="/run/${t}/sock"\nRuntimeDirectory=${t}\nWorkingDirectory=/opt/aven/${t}\nExecStart=${u}\nEnvironment=HOME="${d}"\nUser=${p}\n${a?`\n# Extra configs\n${a}\n`:"\n"}\n[Install]\nWantedBy=default.target\n`;yield r.ensureFileIs(l,m);yield o.exec(`systemctl daemon-reload`);if(n.enable)yield o.exec(`systemctl enable ${t}.service`);yield Promise.all([v,y,_])})}n.setupMainServiceFiles=setupMainServiceFiles},469:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.readAvenConfig=void 0;const i=t(9);let o;let r;const s=new Promise((e,n)=>{o=e;r=n});let c="";process.stdin.on("data",e=>{c+=e});const u=setTimeout(()=>{r(new Error("Timeout reading json input"))},1e3);process.stdin.on("end",()=>{clearTimeout(u);const e=JSON.parse(c);i.debug("Using aven config:",e);o(e)});function readAvenConfig(){return s}n.readAvenConfig=readAvenConfig},470:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};var o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(e!=null)for(var t in e)if(Object.hasOwnProperty.call(e,t))n[t]=e[t];n["default"]=e;return n};Object.defineProperty(n,"__esModule",{value:true});const r=t(431);const s=o(t(87));const c=o(t(622));var u;(function(e){e[e["Success"]=0]="Success";e[e["Failure"]=1]="Failure"})(u=n.ExitCode||(n.ExitCode={}));function exportVariable(e,n){const t=r.toCommandValue(n);process.env[e]=t;r.issueCommand("set-env",{name:e},t)}n.exportVariable=exportVariable;function setSecret(e){r.issueCommand("add-mask",{},e)}n.setSecret=setSecret;function addPath(e){r.issueCommand("add-path",{},e);process.env["PATH"]=`${e}${c.delimiter}${process.env["PATH"]}`}n.addPath=addPath;function getInput(e,n){const t=process.env[`INPUT_${e.replace(/ /g,"_").toUpperCase()}`]||"";if(n&&n.required&&!t){throw new Error(`Input required and not supplied: ${e}`)}return t.trim()}n.getInput=getInput;function setOutput(e,n){r.issueCommand("set-output",{name:e},n)}n.setOutput=setOutput;function setCommandEcho(e){r.issue("echo",e?"on":"off")}n.setCommandEcho=setCommandEcho;function setFailed(e){process.exitCode=u.Failure;error(e)}n.setFailed=setFailed;function isDebug(){return process.env["RUNNER_DEBUG"]==="1"}n.isDebug=isDebug;function debug(e){r.issueCommand("debug",{},e)}n.debug=debug;function error(e){r.issue("error",e instanceof Error?e.toString():e)}n.error=error;function warning(e){r.issue("warning",e instanceof Error?e.toString():e)}n.warning=warning;function info(e){process.stdout.write(e+s.EOL)}n.info=info;function startGroup(e){r.issue("group",e)}n.startGroup=startGroup;function endGroup(){r.issue("endgroup")}n.endGroup=endGroup;function group(e,n){return i(this,void 0,void 0,function*(){startGroup(e);let t;try{t=yield n()}finally{endGroup()}return t})}n.group=group;function saveState(e,n){r.issueCommand("save-state",{name:e},n)}n.saveState=saveState;function getState(e){return process.env[`STATE_${e}`]||""}n.getState=getState},622:function(e){e.exports=require("path")},669:function(e){e.exports=require("util")},708:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupRoot=n.setAuthorizedKeys=void 0;const o=t(2);const r=t(872);const s=t(622);function setAuthorizedKeys(e,n){return i(this,void 0,void 0,function*(){const t=yield r.userHome(e);const i=s.join(t,".ssh");yield o.mkdir(i);yield o.ensureFileIs(s.join(i,"authorized_keys"),[...n,""].join("\n"))})}n.setAuthorizedKeys=setAuthorizedKeys;function setupRoot(e){return i(this,void 0,void 0,function*(){const n=yield r.userHome("root");const t=s.join(n,".ssh");yield o.mkdir(t);if(!e)e=[];yield Promise.all([r.fixKnownHosts(n),setAuthorizedKeys("root",e!==null&&e!==void 0?e:[])])})}n.setupRoot=setupRoot},747:function(e){e.exports=require("fs")},872:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.fixKnownHosts=n.ensureKey=n.createAndConfigureUser=n.userHome=void 0;const o=t(622);const r=t(2);const s=t(311);const c=["sudo","adm","systemd-journal"];const u=9;function userHome(e){return i(this,void 0,void 0,function*(){return e==="root"?"/root":`/home/${e}`})}n.userHome=userHome;function createAndConfigureUser(e){return i(this,void 0,void 0,function*(){const n=[];n.push("useradd");n.push("--no-user-group");n.push("--gid","users");n.push("--shell","/bin/bash");n.push("--create-home");n.push("--groups",c.join(","));n.push(e);yield s.exec(n.join(" ")).catch(n=>{if(n.code!==u)throw n;console.log(`User ${e} exists`)});const t=yield userHome(e);yield r.mkdir(`${t}/.ssh`);yield fixKnownHosts(t)})}n.createAndConfigureUser=createAndConfigureUser;function ensureKey(e,n){return i(this,void 0,void 0,function*(){yield r.ensureFileContains(`${yield userHome(e)}/.ssh/authorized_keys`,n)})}n.ensureKey=ensureKey;const a="github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==";function fixKnownHosts(e){return i(this,void 0,void 0,function*(){return r.ensureFileContains(o.join(e,".ssh","known_hosts"),a)})}n.fixKnownHosts=fixKnownHosts},899:function(e,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.isGitHubAction=void 0;n.isGitHubAction=process.env.GITHUB_ACTIONS==="true"||process.argv.includes("--gh-actions")},947:function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,n,t,i){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})};Object.defineProperty(n,"__esModule",{value:true});n.setupCockpit=void 0;const o=t(285);o.addAptDependencies("cockpit");function setupCockpit(){return i(this,void 0,void 0,function*(){})}n.setupCockpit=setupCockpit}},function(e){"use strict";!function(){e.nmd=function(e){e.paths=[];if(!e.children)e.children=[];Object.defineProperty(e,"loaded",{enumerable:true,get:function(){return e.l}});Object.defineProperty(e,"id",{enumerable:true,get:function(){return e.i}});return e}}()});
//# sourceMappingURL=index.js.map