require('./sourcemap-register.js');module.exports=function(e,t){"use strict";var n={};function __webpack_require__(t){if(n[t]){return n[t].exports}var i=n[t]={i:t,l:false,exports:{}};e[t].call(i.exports,i,i.exports,__webpack_require__);i.l=true;return i.exports}__webpack_require__.ab=__dirname+"/";function startup(){return __webpack_require__(96)}t(__webpack_require__);return startup()}({16:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(311);function setupNetdata(){return i(this,void 0,void 0,function*(){const e="https://my-netdata.io/kickstart-static64.sh";yield r.exec(`bash <(curl -Ss "${e}") --dont-wait`)})}t.setupNetdata=setupNetdata},37:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(808);const o=n(684);function setupTimezone(){return i(this,void 0,void 0,function*(){const{timezone:e}=yield o.readAvenConfig();if(!e)return;const t="/etc/localtime";const n=`/etc/share/zoneinfo/${e}`;r.ensureLinkIs(n,t)})}t.setupTimezone=setupTimezone},42:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(808);const o=n(311);const s=n(747);const c=n(285);const u=n(684);const{mkdir:a,chmod:l}=s.promises;c.addAptDependencies("nginx","certbot");const d="/var/lib/letsencrypt/webroot";const f="/etc/letsencrypt/live";const p=`user www-data;\nworker_processes auto;\npid /run/nginx.pid;\n\ninclude modules-enabled/*.conf;\n\nevents {\n    worker_connections 768;\n    # multi_accept on;\n}\n\nhttp {\n    include conf.d/*.conf;\n}\n`;function setupNginxSnips(){return i(this,void 0,void 0,function*(){const e="/etc/nginx/snips";yield a(e,{recursive:true});const t={};t["force-main-https"]=`location / {\n    return 301 https://$server_name$request_uri;\n    #rewrite ^ https://$server_name$request_uri? permanent;\n}\n`;t.letsencrypt=`location ^~ /.well-known/acme-challenge/ {\n    default_type "text/plain";\n    root ${d};\n}\n\nlocation = /.well-known/acme-challenge/ {\n    return 404;\n}\n`;t["proxy-forwarded-headers"]=`proxy_set_header Host $host;\nproxy_set_header Forwarded $proxy_add_forwarded;\n`;t["proxy-headers"]=`proxy_set_header Host $host;\n#proxy_set_header Port $server_port;\n#proxy_set_header X-Forwarded-Port $server_port;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-Proto $scheme;\n#proxy_set_header X-Forwarded-Ssl $https;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n#proxy_set_header X-Frame-Options SAMEORIGIN;\n`;t["trust-cloudflare-ip"]=`set_real_ip_from 103.21.244.0/22;\nset_real_ip_from 103.22.200.0/22;\nset_real_ip_from 103.31.4.0/22;\nset_real_ip_from 104.16.0.0/12;\nset_real_ip_from 108.162.192.0/18;\nset_real_ip_from 131.0.72.0/22;\nset_real_ip_from 141.101.64.0/18;\nset_real_ip_from 162.158.0.0/15;\nset_real_ip_from 172.64.0.0/13;\nset_real_ip_from 173.245.48.0/20;\nset_real_ip_from 188.114.96.0/20;\nset_real_ip_from 190.93.240.0/20;\nset_real_ip_from 197.234.240.0/22;\nset_real_ip_from 198.41.128.0/17;\nset_real_ip_from 2400:cb00::/32;\nset_real_ip_from 2606:4700::/32;\nset_real_ip_from 2803:f800::/32;\nset_real_ip_from 2405:b500::/32;\nset_real_ip_from 2405:8100::/32;\nset_real_ip_from 2c0f:f248::/32;\nset_real_ip_from 2a06:98c0::/29;\n\n# use any of the following two\nreal_ip_header CF-Connecting-IP;\n#real_ip_header X-Forwarded-For;\n`;t["websockets-proxy-headers"]=`proxy_http_version 1.1;\nproxy_set_header Upgrade $http_upgrade;\nproxy_set_header Connection $connection_upgrade;\n`;yield Promise.all([r.ensureLinkIs("../snippets/fastcgi-php.conf",`${e}/fastcgi-php.conf`),r.ensureFilesAre(Object.entries(t).map(([t,n])=>({filename:`${e}/${t}.conf`,contents:n})))])})}function setupNginxConfigs(){return i(this,void 0,void 0,function*(){const e="/etc/nginx/conf.d";const{domains:t}=yield u.readAvenConfig();yield a(e,{recursive:true});const n={};n.basic=`sendfile on;\ntcp_nopush on;\ntcp_nodelay on;\nkeepalive_timeout 65;\ntypes_hash_max_size 2048;\n# server_tokens off;\n\n# server_names_hash_bucket_size 64;\n# server_name_in_redirect off;\n\ninclude /etc/nginx/mime.types;\ndefault_type application/octet-stream;\n`;n.gzip=`gzip on;\ngzip_disable "msie6";\n\n# gzip_vary on;\n# gzip_proxied any;\n# gzip_comp_level 6;\n# gzip_buffers 16 8k;\n# gzip_http_version 1.1;\n# gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;\n`;n["http-upgrade"]=`map $http_upgrade $connection_upgrade {\n    default upgrade;\n    ''      close;\n}\n`;n.logging=`access_log /var/log/nginx/access.log;\nerror_log /var/log/nginx/error.log;\n`;const i='"~^(,[ \\\\t]*)*([!#$%&\'*+.^_`|~0-9A-Za-z-]+=([!#$%&\'*+.^_`|~0-9A-Za-z-]+|\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\"))?(;([!#$%&\'*+.^_`|~0-9A-Za-z-]+=([!#$%&\'*+.^_`|~0-9A-Za-z-]+|\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\"))?)*([ \\\\t]*,([ \\\\t]*([!#$%&\'*+.^_`|~0-9A-Za-z-]+=([!#$%&\'*+.^_`|~0-9A-Za-z-]+|\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\"))?(;([!#$%&\'*+.^_`|~0-9A-Za-z-]+=([!#$%&\'*+.^_`|~0-9A-Za-z-]+|\\"([\\\\t \\\\x21\\\\x23-\\\\x5B\\\\x5D-\\\\x7E\\\\x80-\\\\xFF]|\\\\\\\\[\\\\t \\\\x21-\\\\x7E\\\\x80-\\\\xFF])*\\"))?)*)?)*$"\n';n["proxy-add-forwarded"]=`map $remote_addr $proxy_forwarded_elem {\n    # IPv4 addresses can be sent as-is\n    ~^[0-9.]+$          "for=$remote_addr";\n\n    # IPv6 addresses need to be bracketed and quoted\n    ~^[0-9A-Fa-f:.]+$   "for=\\"[$remote_addr]\\"";\n\n    # Unix domain socket names cannot be represented in RFC 7239 syntax\n    default             "for=unknown";\n}\n\nmap $http_forwarded $proxy_add_forwarded {\n    # If the incoming Forwarded header is syntactically valid, append to it\n    ${i} "$http_forwarded, $proxy_forwarded_elem";\n\n    # Otherwise, replace it\n    default "$proxy_forwarded_elem";\n}\n`;n.servers=`include servers/*.conf;\n`;n.ssl=`##\n# SSL Settings\n##\n\n# Default keys. Overridden in server configs.\nssl_certificate     ${f}/${t[0]}/fullchain.pem;\nssl_certificate_key ${f}/${t[0]}/privkey.pem;\n\n\nssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE\nssl_prefer_server_ciphers on;\n`;yield r.ensureFilesAre(Object.entries(n).map(([t,n])=>({filename:`${e}/${t}.conf`,contents:n})))})}function setupNginxBasicServers(){return i(this,void 0,void 0,function*(){const e="/etc/nginx/servers";yield a(e,{recursive:true});const t=`server {\n      listen 80;\n      listen [::]:80;\n      listen 443 ssl;\n      listen [::]:443 ssl;\n  \n      include snips/letsencrypt.conf;\n  \n      location / {\n          default_type text/plain;\n          return 200 'Nothing to see here...';\n      }\n  }\n  `;yield r.ensureFileIs(`${e}/00_default.conf`,t)})}function setupNginxServersFull(){return i(this,void 0,void 0,function*(){const{rootPath:e,domains:t,serviceName:n}=yield u.readAvenConfig();if(e)yield a(e,{recursive:true});const i=t[0].replace(".","_");const o="sock";const s=`/run/${n}`;const c=`unix:${s}/${o}`;const l=`server {\n    server_name ${t.join(" ")};\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    include snips/letsencrypt.conf;\n    include snips/force-main-https.conf;\n}\n\nserver {\n    server_name ${t.join(" ")};\n    listen 443 ssl default_server;\n    listen [::]:443 ssl default_server;\n\n    ssl_certificate     ${f}/${t[0]}/fullchain.pem;\n    ssl_certificate_key ${f}/${t[0]}/privkey.pem;\n\n    include snips/trust-cloudflare-ip.conf;\n\n    location / ${!e?"":`{\n      root ${e};\n      # If files exist in root, serve them. Otherwise fallback to proxy.\n      try_files $uri $uri/index.html @proxyHandler;\n    }\n    \n    location @proxyHandler `}{\n        include snips/websockets-proxy-headers.conf;\n        include snips/proxy-headers.conf;\n        proxy_pass http://${i};\n    }\n}\n\nupstream ${i} {\n    server ${c} fail_timeout=0;\n}\n`;yield r.ensureFileIs(`/etc/nginx/servers/${t[0]}.conf`,l)})}const _="/etc/nginx/nginx.conf";function setupNginxBasic(){return i(this,void 0,void 0,function*(){yield Promise.all([r.ensureFileIs(_,p),setupNginxSnips(),setupNginxConfigs(),setupNginxBasicServers()])})}const h=`authenticator = webroot\nwebroot-path = ${d}\n\n# Because we are using logrotate for greater flexibility, disable the\n# internal certbot logrotation.\nmax-log-backups = 0\n`;const y=`#!/bin/bash\nsystemctl reload nginx\n`;function setupCertbot(){return i(this,void 0,void 0,function*(){const{domains:e}=yield u.readAvenConfig();yield Promise.all([r.ensureFileIs("/etc/letsencrypt/cli.ini",h),a(d,{recursive:true})]);const t="/var/lib/znc/znc.pem";const n=`#!/bin/bash\nYOURDOMAIN="${e[0]}"\n\n[[ $RENEWED_LINEAGE != "${f}/$YOURDOMAIN" ]] && exit 0\n\n# Combine certs into single file for some applications that don't support separation\ncat ${f}/$YOURDOMAIN/{privkey,fullchain}.pem > ${t}\n`;yield o.spawn("certbot","certonly","--expand","--noninteractive","--agree-tos","-m",`admin@${e[0]}`,...e.reduce((e,t)=>e.concat("--domain",t),[]));const i="/etc/letsencrypt/renewal-hooks/deploy/reload-nginx";yield r.ensureFileIs(i,y);yield l(i,493)})}function checkNginxConfig(){return i(this,void 0,void 0,function*(){yield o.spawn("nginx","-tc",_)})}function setupNginx(){return i(this,void 0,void 0,function*(){yield setupNginxBasic();yield checkNginxConfig();yield o.exec(`systemctl reload nginx.service`);yield setupCertbot();yield setupNginxServersFull();yield checkNginxConfig();yield o.exec(`systemctl reload nginx.service`)})}t.setupNginx=setupNginx},56:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(808);const o=n(311);const s=n(684);function setupJournalbeat(){return i(this,void 0,void 0,function*(){const{journalbeat:e}=yield s.readAvenConfig();if(!e)return;yield o.exec("wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -");yield r.ensureFileIs("/etc/apt/sources.list.d/elastic-7.x.list","deb https://artifacts.elastic.co/packages/7.x/apt stable main\n");yield o.exec("apt-get update");yield o.exec("apt-get install -y journalbeat");yield o.exec("systemctl enable journalbeat");let t=`journalbeat.inputs:\n  - paths: []\n    #backoff: 1s\n    #max_backoff: 20s\n    seek: cursor\n    #cursor_seek_fallback: head\n    #include_matches: []\n    #fields:\n\n  #journalbeat:\n    #registry_file: registry\n\n  setup.template.settings:\n    index.number_of_shards: 1\n    #index.codec: best_compression\n    #_source.enabled: false\n\n  #name:\n  #tags: ["service-X", "web-tier"]\n  #fields:\n\n  #setup.dashboards.enabled: false\n  #setup.dashboards.url:\n\n  processors:\n    - add_host_metadata: ~\n    - add_cloud_metadata: ~  \n    - decode_json_fields:\n        fields: ["message"]\n        process_array: true\n        max_depth: 8\n        target: ""\n\n  #logging.level: debug\n  #logging.selectors: ["*"]\n\n  #monitoring.enabled: false\n  #monitoring.cluster_uuid:\n  #monitoring.elasticsearch:\n\n  #migration.6_to_7.enabled: true\n\n`;if(e.kibanaHost){t+=`setup.kibana:\n  host: "${e.kibanaHost}"\n\n`}if(e.elastic){t+=`output.elasticsearch:\n  hosts: ${JSON.stringify(e.elastic.hosts)}\n  #protocol: "https"\n  username: ${JSON.stringify(e.elastic.username)}\n  password: ${JSON.stringify(e.elastic.password)}\n\n`}if(e.logstashHosts){t+=`output.logstash:\n  hosts: ${JSON.stringify(e.logstashHosts)}\n  #ssl.certificate_authorities: ["/etc/pki/root/ca.pem"]\n  #ssl.certificate: "/etc/pki/client/cert.pem"\n  #ssl.key: "/etc/pki/client/cert.key"\n\n`}const n=yield r.ensureFileIs("/etc/journalbeat/journalbeat.yml",t);yield o.exec(`systemctl ${n?"restart":"start"} journalbeat`)})}t.setupJournalbeat=setupJournalbeat},96:function(e,t,n){"use strict";e=n.nmd(e);var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(42);const o=n(438);const s=n(263);const c=n(435);const u=n(425);const a=n(305);function prepare(){return i(this,void 0,void 0,function*(){yield a.printOSInfo();yield u.basicServerSetup();yield Promise.all([s.setupMonitoringTools(),c.setupDevTools(),r.setupNginx(),o.setupMainServiceFiles()]);console.log("Server configured!")})}t.prepare=prepare;if(!e.parent){prepare().catch(e=>{console.log("Error running!");console.log(e);process.exitCode=1})}},129:function(e){e.exports=require("child_process")},211:function(e){e.exports=require("https")},263:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(56);const o=n(16);const s=n(947);const c=n(274);const u=n(291);function setupMonitoringTools(){return i(this,void 0,void 0,function*(){yield Promise.all([r.setupJournalbeat(),o.setupNetdata(),s.setupCockpit(),c.setupFailureNotificationService(),u.setupPersistentJournal()])})}t.setupMonitoringTools=setupMonitoringTools},274:function(e,t){"use strict";var n=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});function setupFailureNotificationService(){return n(this,void 0,void 0,function*(){})}t.setupFailureNotificationService=setupFailureNotificationService},285:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(808);const o=n(311);const s=[];function addAptDependencies(...e){s.push(...e)}t.addAptDependencies=addAptDependencies;function setupAptDependencies(){return i(this,void 0,void 0,function*(){yield o.exec("curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -");yield r.ensureFileIs("/etc/apt/sources.list.d/yarn.list","deb https://dl.yarnpkg.com/debian/ stable main");yield o.spawn("apt-get","update");yield o.spawn("apt-get","upgrade","-y");yield o.spawn("apt-get",{stdio:"inherit",env:{DEBIAN_FRONTEND:"noninteractive"}},"install","-yq",...s);yield o.spawn("apt-get","autoremove","-y")})}t.setupAptDependencies=setupAptDependencies},291:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(747);const{mkdir:o}=r.promises;function setupPersistentJournal(){return i(this,void 0,void 0,function*(){yield o("/var/log/journal",{recursive:true})})}t.setupPersistentJournal=setupPersistentJournal},298:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(747);const{readFile:o}=r.promises;let s;function readAvenSecrets(){return i(this,void 0,void 0,function*(){if(s===undefined){const e=yield o("secrets.json");s=JSON.parse(e.toString())}return s})}t.readAvenSecrets=readAvenSecrets},305:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(747);const{readFile:o}=r.promises;function printOSInfo(){return i(this,void 0,void 0,function*(){const e=(yield o("/etc/lsb-release")).toString();const t=e.split("\n")[3].split("=")[1].split('"')[1];console.log("OS Version",t)})}t.printOSInfo=printOSInfo},311:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:true});const i=n(129);const r=n(669);const o="/bin/bash";function spawn(e,t,...n){const r={stdio:"inherit"};const s=typeof t==="string"?i.spawn(e,[t,...n],r):i.spawn(e,n,t===true?Object.assign(Object.assign({},r),{shell:o}):Object.assign(Object.assign({},r),t));const c=new Promise((e,t)=>{s.on("exit",n=>{if(n){t(new Error(`Exit code: ${n}`))}else{e()}})});c.child=s;return c}t.spawn=spawn;const s=r.promisify(i.exec);function exec(e,t=true){if(t===null){return s(e)}if(t===true)t=o;return s(e,{shell:t})}t.exec=exec},411:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(808);const o=n(311);function setupSecurity(){return i(this,void 0,void 0,function*(){const e=yield r.ensureFileContains("/etc/ssh/sshd_config","\nPasswordAuthentication no\n");if(e){yield o.exec("systemctl reload sshd")}})}t.setupSecurity=setupSecurity},425:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(37);const o=n(285);const s=n(411);function basicServerSetup(){return i(this,void 0,void 0,function*(){yield s.setupSecurity();yield r.setupTimezone();yield o.setupAptDependencies()})}t.basicServerSetup=basicServerSetup},435:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(808);const o=n(708);const s=n(285);s.addAptDependencies("screen","git","yarn");t.screenConfig="\ncaption always '%{= dg} %H %{G}| %{B}%l %{G}|%=%?%{d}%-w%?%{r}(%{d}%n %t%? {%u} %?%{r})%{d}%?%+w%?%=%{G}| %{B}%M %d %c:%s '\n";function setupDevTools(){return i(this,void 0,void 0,function*(){yield Promise.all([r.ensureFileContains("/etc/screenrc",t.screenConfig),o.setupRoot()])})}t.setupDevTools=setupDevTools},438:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(747);const o=n(311);const s=n(808);const c=n(684);const{mkdir:u}=r.promises;function setupMainServiceFiles(){var e,t;return i(this,void 0,void 0,function*(){const n=yield c.readAvenConfig();const i=(e=n.serviceName,e!==null&&e!==void 0?e:n.domains[0]);const r=(t=n.serviceDescription,t!==null&&t!==void 0?t:"Runtime server");const a=`/etc/systemd/system/${i}.service`;const l=u(`${a}.d`,{recursive:true});const d=`[Unit]\n  Description=${r}\n  After=network.target\n  \n  [Service]\n  Type=simple\n  Environment=LISTEN_PATH="/run/${i}/sock"\n  RuntimeDirectory=${i}\n  WorkingDirectory=/opt/${i}\n  ExecStart=/usr/bin/npm start\n  User=www-data\n  \n  [Install]\n  WantedBy=default.target\n  `;yield s.ensureFileIs(a,d);yield o.exec(`systemctl daemon-reload`);yield o.exec(`systemctl enable ${i}.service`);yield l})}t.setupMainServiceFiles=setupMainServiceFiles},444:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(211);function request(e){return i(this,void 0,void 0,function*(){return new Promise((t,n)=>i(this,void 0,void 0,function*(){let i="";const o=r.get(e,e=>{e.on("data",e=>{i+=e});e.on("end",()=>{t(i);o.end()})});o.on("error",n)}))})}t.request=request},622:function(e){e.exports=require("path")},669:function(e){e.exports=require("util")},684:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(747);const{readFile:o}=r.promises;let s;function readAvenConfig(){return i(this,void 0,void 0,function*(){if(s===undefined){const e=yield o("aven.json");s=JSON.parse(e.toString());if(!s.domains){throw new Error("`domains` not defined in `aven.json`.")}if(!Array.isArray(s.domains)){throw new Error("`domains` in `aven.json` is not an Array.")}if(s.domains.length<1){throw new Error("Need at least one domain defined")}}return s})}t.readAvenConfig=readAvenConfig},708:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(808);const o=n(444);const s=n(872);const c=n(622);const u=n(747);const a=n(298);const{mkdir:l}=u.promises;function fixAuthorizedKeys(e,t){return i(this,void 0,void 0,function*(){const n=yield s.userHome(e);const u=c.join(n,".ssh");const{deployPublicKey:l}=yield a.readAvenSecrets();yield Promise.all(t.map(e=>i(this,void 0,void 0,function*(){return yield o.request(e)}))).then(e=>[...e,l,""]).then(e=>e.join("\n")).then(e=>r.ensureFileIs(c.join(u,"authorized_keys"),e))})}t.fixAuthorizedKeys=fixAuthorizedKeys;function setupRoot(e){return i(this,void 0,void 0,function*(){const t=yield s.userHome("root");const n=c.join(t,".ssh");yield l(n,{recursive:true});if(!e)e=[];yield Promise.all([s.fixKnownHosts(t),fixAuthorizedKeys("root",e!==null&&e!==void 0?e:[])])})}t.setupRoot=setupRoot},747:function(e){e.exports=require("fs")},808:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(747);const{readFile:o,writeFile:s,symlink:c,readlink:u,unlink:a}=r.promises;function ensureFileContains(e,t){return i(this,void 0,void 0,function*(){const n=(yield o(e).catch(()=>"")).toString();if(n.includes(t))return false;yield s(e,n+t);return true})}t.ensureFileContains=ensureFileContains;function ensureFileIs(e,t,n){return i(this,void 0,void 0,function*(){const i=(yield o(e).catch(()=>"")).toString();if(i===t)return false;yield s(e,t,{mode:n});return true})}t.ensureFileIs=ensureFileIs;function ensureFilesAre(e){return i(this,void 0,void 0,function*(){yield Promise.all(e.map(({filename:e,contents:t})=>ensureFileIs(e,t)))})}t.ensureFilesAre=ensureFilesAre;function ensureLinkIs(e,t){return i(this,void 0,void 0,function*(){const n=yield u(t).catch(e=>{if(e.code==="ENOENT")return undefined;throw e});if(e===n)return;if(n!==undefined)yield a(t);yield c(e,t)})}t.ensureLinkIs=ensureLinkIs},872:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(622);const o=n(747);const s=n(808);const c=n(311);const{mkdir:u}=o.promises;const a=["sudo","adm","systemd-journal"];const l=9;function userHome(e){return i(this,void 0,void 0,function*(){return e==="root"?"/root":`/home/${e}`})}t.userHome=userHome;function createAndConfigureUser(e){return i(this,void 0,void 0,function*(){const t=[];t.push("useradd");t.push("--no-user-group");t.push("--gid","users");t.push("--shell","/bin/bash");t.push("--create-home");t.push("--groups",a.join(","));t.push(e);yield c.exec(t.join(" ")).catch(t=>{if(t.code!==l)throw t;console.log(`User ${e} exists`)});const n=yield userHome(e);yield u(`${n}/.ssh`,{recursive:true});yield fixKnownHosts(n)})}t.createAndConfigureUser=createAndConfigureUser;function ensureKey(e,t){return i(this,void 0,void 0,function*(){yield s.ensureFileContains(`${yield userHome(e)}/.ssh/authorized_keys`,t)})}t.ensureKey=ensureKey;const d="github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==";function fixKnownHosts(e){return i(this,void 0,void 0,function*(){return s.ensureFileContains(r.join(e,".ssh","known_hosts"),d)})}t.fixKnownHosts=fixKnownHosts},947:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:true});const r=n(285);r.addAptDependencies("cockpit");function setupCockpit(){return i(this,void 0,void 0,function*(){})}t.setupCockpit=setupCockpit}},function(e){"use strict";!function(){e.nmd=function(e){e.paths=[];if(!e.children)e.children=[];Object.defineProperty(e,"loaded",{enumerable:true,get:function(){return e.l}});Object.defineProperty(e,"id",{enumerable:true,get:function(){return e.i}});return e}}()});
//# sourceMappingURL=index.js.map